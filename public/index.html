<!-- public/index.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <title>è½‰è½‰å°ç‘ªè‰ æŠ½ç</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* ç°¡æ˜“æ’ç‰ˆç•¥ */
  </style>
</head>
<body>
  <h1>ğŸ° è½‰è½‰å°ç‘ªè‰</h1>
  <button id="btnStart" disabled>è¼‰å…¥ä¸­â€¦</button>
  <div id="form" style="display:none">
    <input id="name" placeholder="å§“å" /><br/>
    <input id="phone" placeholder="æ‰‹æ©Ÿ" /><br/>
    <button id="btnSubmit">é€å‡º</button>
  </div>
  <p id="msg"></p>

<script>
const LIFF_ID = '1656871455-A1lEEOaB';            // â† æ›æˆä½ çš„ LIFF ID
const API_URL = '/.netlify/functions/lottery';   // Netlify Function endpoint

let idToken, userId, dispName;

async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId   = profile.userId;
  dispName = profile.displayName;
  idToken  = await liff.getIDToken();

  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnStart').innerText = 'é–‹å§‹æŠ½ç';
}
init();

// é»ã€Œé–‹å§‹æŠ½çã€
document.getElementById('btnStart').onclick = async () => {
  document.getElementById('btnStart').style.display = 'none';
  const res = await fetch(API_URL, {
    method:'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({
      act:'draw',
      idToken,                 // é©—è­‰ç”¨
    })
  });
  const j = await res.json();
  if (j.error) {
    alert('æŠ½çå‡ºéŒ¯ï¼š'+j.error);
    return;
  }
  // é¡¯ç¤ºè¡¨å–®
  document.getElementById('form').style.display = 'block';
};

// é»ã€Œé€å‡ºã€
document.getElementById('btnSubmit').onclick = async () => {
  const name  = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  if (!name || !phone) return alert('è«‹å¡«å§“åï¼æ‰‹æ©Ÿ');

  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body:JSON.stringify({
      act:'winner',
      idToken,
      name, phone
    })
  });
  const j = await res.json();
  if (!j.ok) return alert('å¯«å…¥å¤±æ•—ï¼š'+j.msg);
  document.getElementById('msg').innerText = `âœ… ä¸­çç‚º ${j.prize}ï¼`;
};
</script>
</body>
</html>
